<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yb.dao.NotOilDao">
	<select id="queryNotOils" resultType="NotOil">
		select 
		<if test="date=='minute'">
			DATE_FORMAT(minutes,'%Y-%m-%d %H:%i')
		</if>
		<if test="date=='hour'">
			DATE_FORMAT(minutes,'%Y-%m-%d %H')
		</if>
		<if test="date=='day'">
			DATE_FORMAT(minutes,'%Y-%m-%d')
		</if>
		<if test="date=='month'">
			DATE_FORMAT(minutes,'%Y-%m')
		</if>
		<if test="date=='year'">
			DATE_FORMAT(minutes,'%Y')
		</if> as minutes,
		sum(notoilNumber) notOilNumber,sum(notoilMoney) notoilMoney,sum(notoilMoney)/sum(notoilNumber) avgMoney
		
		from res_notoil ro left join station on ro.stationID=station.id left join tag_station st
		
		on station.id=st.stationId left join tag on st.tagId=tag.id left join category on
		
		station.categoryId=category.id
		
		<if test="query=='station'">
			where ro.stationId=#{station}
		</if>
		<if test="query=='category'">
			where category.id=#{station}
		</if>
		<if test="query=='tag'">
			where tag.id=#{station}
		</if> and minutes between DATE_FORMAT(#{start},'%Y-%m-%d %H:%i') and DATE_FORMAT(#{end},'%Y-%m-%d %H:%i')
		group by 1
	</select>
	<select id="queryByDepartmentName" resultType="NotOil">
		select 
		<if test="date=='minute'">
			DATE_FORMAT(minutes,'%Y-%m-%d %H:%i')
		</if>
		<if test="date=='hour'">
			DATE_FORMAT(minutes,'%Y-%m-%d %H')
		</if>
		<if test="date=='day'">
			DATE_FORMAT(minutes,'%Y-%m-%d')
		</if>
		<if test="date=='month'">
			DATE_FORMAT(minutes,'%Y-%m')
		</if>
		<if test="date=='year'">
			DATE_FORMAT(minutes,'%Y')
		</if> as minutes,
		sum(departmentMoney) notoilMoney from res_notoilDepartment ro left join station on ro.stationID=station.id left join tag_station st
		
		on station.id=st.stationId left join tag on st.tagId=tag.id left join category on
		
		station.categoryId=category.id
		
		<if test="query=='station'">
			where station.id=#{station}
		</if>
		<if test="query=='category'">
			where category.id=#{station}
		</if>
		<if test="query=='tag'">
			where tag.id=#{station}
		</if>and departmentName=#{departmentName} and minutes between DATE_FORMAT(#{start},'%Y-%m-%d %H:%i') and DATE_FORMAT(#{end},'%Y-%m-%d %H:%i')
		group by 1,departmentName
	</select>
	<select id="queryAllName" resultType="String">
		select distinct departmentName from res_notoilDepartment
	</select>
	<!-- 这是为了求便利店的开单率 -->
	<select id="queryRate" resultType="NotOil">
		select <if test="date=='minute'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d %H:%i')
		</if>
		<if test="date=='hour'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d %H')
		</if>
		<if test="date=='day'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d')
		</if>
		<if test="date=='month'">
			DATE_FORMAT(ran.minutes,'%Y-%m')
		</if>
		<if test="date=='year'">
			DATE_FORMAT(ran.minutes,'%Y')
		</if> as minutes,
		sum(rno.notoilNumber)/sum(ran.tradeNumber) avgMoney 
		
		from res_allNumber ran left join res_notoil rno on ran.stationID=rno.stationID
		
		and <if test="date=='minute'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d %H:%i')=DATE_FORMAT(rno.minutes,'%Y-%m-%d %H:%i')
		</if>
		<if test="date=='hour'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d %H')=DATE_FORMAT(rno.minutes,'%Y-%m-%d %H')
		</if>
		<if test="date=='day'">
			DATE_FORMAT(ran.minutes,'%Y-%m-%d')=DATE_FORMAT(rno.minutes,'%Y-%m-%d')
		</if>
		<if test="date=='month'">
			DATE_FORMAT(ran.minutes,'%Y-%m')=DATE_FORMAT(rno.minutes,'%Y-%m')
		</if>
		<if test="date=='year'">
			DATE_FORMAT(ran.minutes,'%Y')=DATE_FORMAT(rno.minutes,'%Y')
		</if>
		left join station on ran.stationID=station.id left join tag_station st
		
		on station.id=st.stationId left join tag on st.tagId=tag.id left join category on
		
		station.categoryId=category.id
		
		where
		<if test="query=='station'">
			station.id=#{station}
		</if>
		<if test="query=='category'">
			category.id=#{station}
		</if>
		<if test="query=='tag'">
			tag.id=#{station}
		</if>
		
		and ran.minutes between DATE_FORMAT(#{start},'%Y-%m-%d %H:%i') and DATE_FORMAT(#{end},'%Y-%m-%d %H:%i')
		
		group by 1
	</select>
</mapper>
